<div class="mis-turnos-container">
  <h1>Mis Turnos</h1>

  <!-- Filtro Global -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="searchText">üîç Buscar en turnos e historias cl√≠nicas:</label>
      <input 
        type="text" 
        id="searchText"
        [(ngModel)]="searchText"
        (input)="applyFilters()"
        placeholder="Buscar por especialidad, especialista, fecha, diagn√≥stico, presi√≥n, etc..."
        class="filter-input search-input">
      <small class="filter-hint">
        Pod√©s buscar por cualquier campo: especialidad, especialista, estado, diagn√≥stico, altura, peso, temperatura, presi√≥n, o campos personalizados de la historia cl√≠nica.
      </small>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <p>Cargando turnos...</p>
  </div>

  <!-- Lista de turnos -->
  <div *ngIf="!loading && filteredAppointments.length > 0" class="appointments-list">
    <div *ngFor="let appointment of filteredAppointments" class="appointment-card">
      <div class="appointment-header">
        <h3>{{ appointment.specialty_name }}</h3>
        <span [class]="getStatusClass(appointment.status_id)" class="status-badge">
          {{ getStatusText(appointment) }}
        </span>
      </div>

      <div class="appointment-details">
        <p><strong>Especialista:</strong> Dr/a. {{ appointment.specialist_name }} {{ appointment.specialist_last_name }}</p>
        <p><strong>Fecha:</strong> {{ formatDate(appointment.appointment_date) }}</p>
        <p><strong>Hora:</strong> {{ formatTime(appointment.appointment_time || '') }}</p>
        <p><strong>Duraci√≥n:</strong> {{ appointment.duration_minutes }} minutos</p>
        
        <div *ngIf="appointment.cancellation_reason" class="cancellation-info">
          <p><strong>Motivo de cancelaci√≥n:</strong> {{ appointment.cancellation_reason }}</p>
        </div>

        <div *ngIf="appointment.rejection_reason" class="rejection-info">
          <p><strong>Motivo de rechazo:</strong> {{ appointment.rejection_reason }}</p>
        </div>

        <div *ngIf="appointment.patient_rating" class="rating-info">
          <p><strong>Tu calificaci√≥n:</strong> {{ appointment.patient_rating }} ‚≠ê</p>
          <p *ngIf="appointment.patient_feedback"><strong>Tu comentario:</strong> {{ appointment.patient_feedback }}</p>
        </div>

        <div *ngIf="appointment.survey_completed" class="survey-info">
          <p><strong>‚úì Encuesta completada</strong></p>
        </div>
      </div>

      <div class="appointment-actions">
        <button 
          *ngIf="canCancel(appointment)"
          (click)="openCancelModal(appointment)"
          class="btn btn-danger">
          Cancelar Turno
        </button>

        <button 
          *ngIf="canViewReview(appointment)"
          (click)="openReviewModal(appointment)"
          class="btn btn-info">
          Ver Rese√±a
        </button>

        <button 
          *ngIf="canCompleteSurvey(appointment)"
          (click)="openSurveyModal(appointment)"
          class="btn btn-primary">
          Completar Encuesta
        </button>

        <button 
          *ngIf="canRate(appointment)"
          (click)="openRatingModal(appointment)"
          class="btn btn-warning">
          Calificar Atenci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- Sin turnos -->
  <div *ngIf="!loading && filteredAppointments.length === 0" class="no-appointments">
    <p *ngIf="appointments.length === 0">No tienes turnos registrados</p>
    <p *ngIf="appointments.length > 0 && filteredAppointments.length === 0">
      No se encontraron turnos con los filtros aplicados
    </p>
  </div>
</div>

<!-- Modal Cancelar Turno -->
<div *ngIf="showCancelModal" class="modal-overlay" (click)="closeCancelModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Cancelar Turno</h2>
    <p>¬øEst√° seguro que desea cancelar este turno?</p>
    
    <div class="form-group">
      <label for="cancellationReason">Motivo de cancelaci√≥n *</label>
      <textarea 
        id="cancellationReason"
        [(ngModel)]="cancellationReason"
        rows="4"
        placeholder="Ingrese el motivo de la cancelaci√≥n"
        class="form-control"></textarea>
    </div>

    <div class="modal-actions">
      <button (click)="closeCancelModal()" class="btn btn-secondary">Cerrar</button>
      <button (click)="confirmCancel()" class="btn btn-danger">Confirmar Cancelaci√≥n</button>
    </div>
  </div>
</div>

<!-- Modal Ver Rese√±a -->
<div *ngIf="showReviewModal" class="modal-overlay" (click)="closeReviewModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Rese√±a del Especialista</h2>
    
    <div class="review-content">
      <p><strong>Especialista:</strong> Dr/a. {{ selectedAppointment?.specialist_name }} {{ selectedAppointment?.specialist_last_name }}</p>
      <p><strong>Fecha:</strong> {{ formatDate(selectedAppointment?.appointment_date || '') }}</p>
      <p><strong>Hora:</strong> {{ formatTime(selectedAppointment?.appointment_time || '') }}</p>
      
      <div class="review-text">
        <h3>Diagn√≥stico y Observaciones:</h3>
        <p>{{ selectedAppointment?.specialist_review }}</p>
      </div>
    </div>

    <div class="modal-actions">
      <button (click)="closeReviewModal()" class="btn btn-primary">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal Encuesta -->
<div *ngIf="showSurveyModal" class="modal-overlay" (click)="closeSurveyModal()">
  <div class="modal-content survey-modal" (click)="$event.stopPropagation()">
    <h2>Encuesta de Satisfacci√≥n</h2>
    <p class="survey-intro">Por favor, ay√∫denos a mejorar nuestro servicio respondiendo las siguientes preguntas:</p>
    
    <form class="survey-form">
      <div class="form-group">
        <label>1. ¬øC√≥mo calificar√≠a la atenci√≥n recibida? *</label>
        <input 
          type="text" 
          [(ngModel)]="surveyAnswers.question1"
          name="q1"
          class="form-control"
          placeholder="Ej: Excelente, Muy buena, Buena, Regular, Mala">
      </div>

      <div class="form-group">
        <label>2. ¬øEl especialista fue puntual? *</label>
        <input 
          type="text" 
          [(ngModel)]="surveyAnswers.question2"
          name="q2"
          class="form-control"
          placeholder="Ej: S√≠, No, Lleg√≥ con X minutos de retraso">
      </div>

      <div class="form-group">
        <label>3. ¬øEl especialista explic√≥ claramente su diagn√≥stico? *</label>
        <input 
          type="text" 
          [(ngModel)]="surveyAnswers.question3"
          name="q3"
          class="form-control"
          placeholder="Ej: S√≠, No, Parcialmente">
      </div>

      <div class="form-group">
        <label>4. ¬øRecomendar√≠a este especialista a otros pacientes? *</label>
        <input 
          type="text" 
          [(ngModel)]="surveyAnswers.question4"
          name="q4"
          class="form-control"
          placeholder="Ej: S√≠, No, Tal vez">
      </div>

      <div class="form-group">
        <label>5. ¬øLas instalaciones de la cl√≠nica fueron adecuadas? *</label>
        <input 
          type="text" 
          [(ngModel)]="surveyAnswers.question5"
          name="q5"
          class="form-control"
          placeholder="Ej: Excelente, Buena, Regular, Mala">
      </div>

      <div class="form-group">
        <label>6. Comentarios adicionales (opcional)</label>
        <textarea 
          [(ngModel)]="surveyAnswers.question6"
          name="q6"
          rows="5"
          maxlength="300"
          class="form-control"
          placeholder="Ingrese cualquier comentario o sugerencia adicional (m√°ximo 5 l√≠neas)"></textarea>
        <small class="char-counter">{{ surveyAnswers.question6.length }}/300 caracteres</small>
      </div>
    </form>

    <div class="modal-actions">
      <button (click)="closeSurveyModal()" class="btn btn-secondary">Cerrar</button>
      <button (click)="submitSurvey()" class="btn btn-primary">Enviar Encuesta</button>
    </div>
  </div>
</div>

<!-- Modal Calificaci√≥n -->
<div *ngIf="showRatingModal" class="modal-overlay" (click)="closeRatingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Calificar Atenci√≥n</h2>
    
    <div class="rating-section">
      <p>Seleccione su calificaci√≥n (1-5 estrellas):</p>
      <div class="stars">
        <span 
          *ngFor="let star of [1, 2, 3, 4, 5]"
          (click)="setRating(star)"
          [class.selected]="star <= rating"
          class="star">
          ‚≠ê
        </span>
      </div>
      <p class="rating-value" *ngIf="rating > 0">{{ rating }} estrella(s)</p>
    </div>

    <div class="form-group">
      <label for="patientComment">Comentario sobre la atenci√≥n *</label>
      <textarea 
        id="patientComment"
        [(ngModel)]="patientComment"
        (input)="onCommentInput($event)"
        rows="5"
        maxlength="300"
        placeholder="Describa c√≥mo fue la atenci√≥n del especialista (m√°ximo 5 l√≠neas)"
        class="form-control"></textarea>
      <small class="char-counter">{{ patientComment.length }}/300 caracteres</small>
    </div>

    <div class="modal-actions">
      <button (click)="closeRatingModal()" class="btn btn-secondary">Cerrar</button>
      <button (click)="submitRating()" class="btn btn-primary">Enviar Calificaci√≥n</button>
    </div>
  </div>
</div>
