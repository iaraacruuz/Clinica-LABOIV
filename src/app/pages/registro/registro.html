<div class="register-container">
  <div class="register-card" @slideInFromRight>
    <div class="clinic-logo">
      <img src="clinic-icon.svg" alt="ClÃ­nica Online" />
    </div>
    
    <button class="btn-back" (click)="goBackWithConfirmation()" title="Volver atrÃ¡s">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Volver
    </button>

    <h2 *ngIf="!role">Â¡Hola!</h2>
    <h2 *ngIf="role">Registro</h2>

    <!-- SelecciÃ³n de rol con diseÃ±o moderno -->
    <div class="role-selection" *ngIf="!role" @fadeIn>
      <p class="register-link-text">
        <a href="/login" class="link-blue">Registrate ahora</a>
      </p>
      
      <button class="role-card patient-card" (click)="selectRole('patient')">
        <div class="role-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="#4A90E2" stroke="none">
            <circle cx="12" cy="8" r="4" fill="#87CEEB"/>
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="#4A90E2"/>
            <circle cx="12" cy="7" r="3" fill="#FFE4C4"/>
          </svg>
        </div>
        <h3>Paciente</h3>
        <p>Busca el profesional que necesitas y reserva un turno.</p>
      </button>

      <button class="role-card specialist-card" (click)="selectRole('specialist')">
        <div class="role-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="#2C3E50" stroke="none">
            <circle cx="12" cy="8" r="4" fill="#34495E"/>
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="#2C3E50"/>
            <circle cx="12" cy="7" r="3" fill="#FFE4C4"/>
            <rect x="10" y="3" width="4" height="8" fill="#E74C3C" rx="0.5"/>
            <rect x="8" y="5" width="8" height="4" fill="#E74C3C" rx="0.5"/>
          </svg>
        </div>
        <h3>Especialista</h3>
        <p>Gestiona tus turnos y permite que tus pacientes te encuentren fÃ¡cilmente.</p>
      </button>
    </div>

    <!-- Formulario (solo se muestra despuÃ©s de seleccionar rol) -->
    <div *ngIf="role" class="form-content">
      <div class="selected-role-badge">
        <span>{{ role === 'patient' ? 'ğŸ‘¤ Paciente' : 'âš•ï¸ Especialista' }}</span>
        <button class="btn-change-role" (click)="changeRole()" title="Cambiar tipo de usuario">Cambiar</button>
      </div>

    <!-- Datos personales -->
    <input 
      type="text" 
      placeholder="Nombre" 
      [(ngModel)]="name" 
      name="name" 
      (blur)="validateName()"
      (input)="validateName()"
      class="input-field"
      [class.input-error]="nameTouched && nameError" 
    />
    <div *ngIf="nameTouched && nameError" class="error-message">{{ nameError }}</div>

    <input 
      type="text" 
      placeholder="Apellido" 
      [(ngModel)]="last_name" 
      name="last_name"
      (blur)="validateLastName()"
      (input)="validateLastName()"
      class="input-field"
      [class.input-error]="lastNameTouched && lastNameError"
    />
    <div *ngIf="lastNameTouched && lastNameError" class="error-message">{{ lastNameError }}</div>

    <input 
      type="number" 
      placeholder="Edad" 
      [(ngModel)]="age" 
      name="age"
      (blur)="validateAge()"
      (input)="validateAge()"
      class="input-field"
      [class.input-error]="ageTouched && ageError"
    />
    <div *ngIf="ageTouched && ageError" class="error-message">{{ ageError }}</div>

    <input 
      type="text" 
      placeholder="DNI" 
      [(ngModel)]="dni" 
      name="dni"
      (blur)="validateDni()"
      (input)="validateDni()"
      class="input-field"
      [class.input-error]="dniTouched && dniError"
    />
    <div *ngIf="dniTouched && dniError" class="error-message">{{ dniError }}</div>

    <input 
      type="email" 
      placeholder="Email" 
      [(ngModel)]="email" 
      name="email"
      (blur)="validateEmail()"
      (input)="validateEmail()"
      class="input-field"
      [class.input-error]="emailTouched && emailError"
    />
    <div *ngIf="emailTouched && emailError" class="error-message">{{ emailError }}</div>

    <input 
      type="password" 
      placeholder="ContraseÃ±a" 
      [(ngModel)]="password" 
      name="password"
      (blur)="validatePassword()"
      (input)="validatePassword()"
      class="input-field"
      [class.input-error]="passwordTouched && passwordError"
    />
    <div *ngIf="passwordTouched && passwordError" class="error-message">{{ passwordError }}</div>

    <!-- Obra social si es paciente -->
    <div *ngIf="role === 'patient'" class="fade-field">
      <input 
        type="text" 
        placeholder="Obra Social" 
        [(ngModel)]="health_insurance" 
        name="health_insurance"
        (blur)="validateHealthInsurance()"
        (input)="validateHealthInsurance()"
        class="input-field"
        [class.input-error]="healthInsuranceTouched && healthInsuranceError"
      />
      <div *ngIf="healthInsuranceTouched && healthInsuranceError" class="error-message">{{ healthInsuranceError }}</div>
    </div>

    <!-- Especialidad si es especialista -->
    <div *ngIf="role === 'specialist'" class="fade-field">
      <label for="specialty" class="input-label">Especialidades</label>
      
      <!-- Especialidades seleccionadas -->
      <div *ngIf="selectedSpecialties.length > 0" class="selected-specialties">
        <div *ngFor="let specId of selectedSpecialties" class="specialty-tag">
          {{ getSpecialtyName(specId) }}
          <button type="button" class="remove-specialty" (click)="removeSpecialty(specId)">âœ•</button>
        </div>
      </div>
      
      <!-- Selector de especialidades -->
      <select 
        name="specialty" 
        id="specialty" 
        class="input-field" 
        (change)="onSpecialtyChange($event); validateSpecialty()"
        (blur)="validateSpecialty()"
        [class.input-error]="specialtyTouched && specialtyError"
      >
        <option value="">-- Seleccionar especialidad --</option>
        <option *ngFor="let esp of specialities" [value]="esp.id">{{ esp.name }}</option>
        <option value="otra">âœï¸ Agregar nueva especialidad</option>
      </select>
      <div *ngIf="specialtyTouched && specialtyError" class="error-message">{{ specialtyError }}</div>

      <!-- Campo para especialidad personalizada -->
      <div *ngIf="showCustomSpecialty" class="fade-field custom-specialty-input">
        <input 
          type="text" 
          placeholder="Ingrese la especialidad (solo letras)" 
          [(ngModel)]="customSpecialty" 
          name="customSpecialty"
          class="input-field"
          (keyup.enter)="addCustomSpecialty()"
        />
        <div class="custom-specialty-buttons">
          <button type="button" class="btn-add-specialty" (click)="addCustomSpecialty()">
            âœ“ Agregar
          </button>
          <button type="button" class="btn-cancel-specialty" (click)="cancelCustomSpecialty()">
            âœ• Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- ImÃ¡genes de perfil para PACIENTES (2 imÃ¡genes) -->
    <div *ngIf="role === 'patient'" class="fade-field images-section">
      <label class="input-label">ImÃ¡genes de perfil (2 requeridas)</label>
      
      <div class="image-upload-container">
        <div class="image-upload-item">
          <label class="upload-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 1)" style="display: none;" />
            <div class="upload-box" [class.has-image]="profileImage1Preview">
              <div *ngIf="!profileImage1Preview" class="upload-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Imagen 1</span>
              </div>
              <img *ngIf="profileImage1Preview" [src]="profileImage1Preview" alt="Preview 1" />
            </div>
          </label>
          <button *ngIf="profileImage1" class="btn-remove-image" (click)="removeImage(1)" type="button">
            âœ• Eliminar
          </button>
        </div>

        <div class="image-upload-item">
          <label class="upload-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 2)" style="display: none;" />
            <div class="upload-box" [class.has-image]="profileImage2Preview">
              <div *ngIf="!profileImage2Preview" class="upload-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Imagen 2</span>
              </div>
              <img *ngIf="profileImage2Preview" [src]="profileImage2Preview" alt="Preview 2" />
            </div>
          </label>
          <button *ngIf="profileImage2" class="btn-remove-image" (click)="removeImage(2)" type="button">
            âœ• Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Imagen de perfil para ESPECIALISTAS (1 imagen) -->
    <div *ngIf="role === 'specialist'" class="fade-field images-section">
      <label class="input-label">Imagen de perfil (requerida)</label>
      
      <div class="image-upload-container single-image">
        <div class="image-upload-item">
          <label class="upload-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 1)" style="display: none;" />
            <div class="upload-box" [class.has-image]="profileImage1Preview">
              <div *ngIf="!profileImage1Preview" class="upload-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Click para subir imagen</span>
              </div>
              <img *ngIf="profileImage1Preview" [src]="profileImage1Preview" alt="Preview" />
            </div>
          </label>
          <button *ngIf="profileImage1" class="btn-remove-image" (click)="removeImage(1)" type="button">
            âœ• Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div class="loader-overlay" *ngIf="loading">
      <div class="spinner"></div>
      <p>Registrando usuario...</p>
    </div>

    <!-- Sprint 5: Captcha Personalizado con Directiva -->
    <div 
      [appCaptcha]="true"
      (captchaValidated)="onCaptchaValidated($event)"
      class="captcha-directive-container">
    </div>

    <button (click)="register()" class="btn-register" [disabled]="loading || !isFormValid()">Registrarse</button>

    <div class="login-link">
      <p>Â¿Ya tenÃ©s cuenta?</p>
      <button class="btn-link-login" (click)="goToLogin()">IniciÃ¡ sesiÃ³n aquÃ­</button>
    </div>
    </div>
  </div>
</div>

<app-confirmation-modal
  [isVisible]="showBackConfirmation"
  [title]="'Â¿Volver atrÃ¡s?'"
  [message]="'Â¿EstÃ¡s seguro que deseas volver? Los datos del formulario se perderÃ¡n.'"
  [confirmText]="'SÃ­, volver'"
  [cancelText]="'Cancelar'"
  (onConfirm)="confirmGoBack()"
  (onCancel)="cancelGoBack()">
</app-confirmation-modal>
