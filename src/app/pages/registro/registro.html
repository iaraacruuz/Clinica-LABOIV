<div class="register-container">
  <div class="register-card">
    <div class="clinic-logo">
      <img src="clinic-icon.svg" alt="Clínica Online" />
    </div>
    
    <button class="btn-back" (click)="goBackWithConfirmation()" title="Volver atrás">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Volver
    </button>

    <h2>Registro</h2>

    <!-- Selección de rol -->
    <label for="role" class="input-label">Tipo de usuario</label>
    <select [(ngModel)]="role" name="role" id="role" class="input-field">
      <option value="patient">Paciente</option>
      <option value="specialist">Especialista</option>
    </select>

    <!-- Datos personales -->
    <input 
      type="text" 
      placeholder="Nombre" 
      [(ngModel)]="name" 
      name="name" 
      (blur)="validateName()"
      (input)="validateName()"
      class="input-field"
      [class.input-error]="nameTouched && nameError" 
    />
    <div *ngIf="nameTouched && nameError" class="error-message">{{ nameError }}</div>

    <input 
      type="text" 
      placeholder="Apellido" 
      [(ngModel)]="last_name" 
      name="last_name"
      (blur)="validateLastName()"
      (input)="validateLastName()"
      class="input-field"
      [class.input-error]="lastNameTouched && lastNameError"
    />
    <div *ngIf="lastNameTouched && lastNameError" class="error-message">{{ lastNameError }}</div>

    <input 
      type="number" 
      placeholder="Edad" 
      [(ngModel)]="age" 
      name="age"
      (blur)="validateAge()"
      (input)="validateAge()"
      class="input-field"
      [class.input-error]="ageTouched && ageError"
    />
    <div *ngIf="ageTouched && ageError" class="error-message">{{ ageError }}</div>

    <input 
      type="text" 
      placeholder="DNI" 
      [(ngModel)]="dni" 
      name="dni"
      (blur)="validateDni()"
      (input)="validateDni()"
      class="input-field"
      [class.input-error]="dniTouched && dniError"
    />
    <div *ngIf="dniTouched && dniError" class="error-message">{{ dniError }}</div>

    <input 
      type="email" 
      placeholder="Email" 
      [(ngModel)]="email" 
      name="email"
      (blur)="validateEmail()"
      (input)="validateEmail()"
      class="input-field"
      [class.input-error]="emailTouched && emailError"
    />
    <div *ngIf="emailTouched && emailError" class="error-message">{{ emailError }}</div>

    <input 
      type="password" 
      placeholder="Contraseña" 
      [(ngModel)]="password" 
      name="password"
      (blur)="validatePassword()"
      (input)="validatePassword()"
      class="input-field"
      [class.input-error]="passwordTouched && passwordError"
    />
    <div *ngIf="passwordTouched && passwordError" class="error-message">{{ passwordError }}</div>

    <!-- Obra social si es paciente -->
    <div *ngIf="role === 'patient'" class="fade-field">
      <input 
        type="text" 
        placeholder="Obra Social" 
        [(ngModel)]="health_insurance" 
        name="health_insurance"
        (blur)="validateHealthInsurance()"
        (input)="validateHealthInsurance()"
        class="input-field"
        [class.input-error]="healthInsuranceTouched && healthInsuranceError"
      />
      <div *ngIf="healthInsuranceTouched && healthInsuranceError" class="error-message">{{ healthInsuranceError }}</div>
    </div>

    <!-- Especialidad si es especialista -->
    <div *ngIf="role === 'specialist'" class="fade-field">
      <label for="specialty" class="input-label">Especialidad</label>
      <select 
        [(ngModel)]="specialty" 
        name="specialty" 
        id="specialty" 
        class="input-field" 
        (change)="onSpecialtyChange(); validateSpecialty()"
        (blur)="validateSpecialty()"
        [class.input-error]="specialtyTouched && specialtyError"
      >
        <option value="">-- Seleccionar especialidad --</option>
        <option *ngFor="let esp of specialities" [value]="esp.name">{{ esp.name }}</option>
        <option value="otra">✏️ Agregar otra especialidad</option>
      </select>
      <div *ngIf="specialtyTouched && specialtyError" class="error-message">{{ specialtyError }}</div>

      <!-- Campo para especialidad personalizada -->
      <div *ngIf="showCustomSpecialty" class="fade-field" style="margin-top: 10px;">
        <input 
          type="text" 
          placeholder="Ingrese la especialidad" 
          [(ngModel)]="customSpecialty" 
          name="customSpecialty"
          (blur)="validateSpecialty()"
          (input)="validateSpecialty()"
          class="input-field"
          [class.input-error]="specialtyTouched && specialtyError"
        />
      </div>
    </div>

    <!-- Imágenes de perfil para PACIENTES (2 imágenes) -->
    <div *ngIf="role === 'patient'" class="fade-field images-section">
      <label class="input-label">Imágenes de perfil (2 requeridas)</label>
      
      <div class="image-upload-container">
        <div class="image-upload-item">
          <label class="upload-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 1)" style="display: none;" />
            <div class="upload-box" [class.has-image]="profileImage1Preview">
              <div *ngIf="!profileImage1Preview" class="upload-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Imagen 1</span>
              </div>
              <img *ngIf="profileImage1Preview" [src]="profileImage1Preview" alt="Preview 1" />
            </div>
          </label>
          <button *ngIf="profileImage1" class="btn-remove-image" (click)="removeImage(1)" type="button">
            ✕ Eliminar
          </button>
        </div>

        <div class="image-upload-item">
          <label class="upload-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 2)" style="display: none;" />
            <div class="upload-box" [class.has-image]="profileImage2Preview">
              <div *ngIf="!profileImage2Preview" class="upload-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Imagen 2</span>
              </div>
              <img *ngIf="profileImage2Preview" [src]="profileImage2Preview" alt="Preview 2" />
            </div>
          </label>
          <button *ngIf="profileImage2" class="btn-remove-image" (click)="removeImage(2)" type="button">
            ✕ Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Imagen de perfil para ESPECIALISTAS (1 imagen) -->
    <div *ngIf="role === 'specialist'" class="fade-field images-section">
      <label class="input-label">Imagen de perfil (requerida)</label>
      
      <div class="image-upload-container single-image">
        <div class="image-upload-item">
          <label class="upload-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 1)" style="display: none;" />
            <div class="upload-box" [class.has-image]="profileImage1Preview">
              <div *ngIf="!profileImage1Preview" class="upload-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <span>Click para subir imagen</span>
              </div>
              <img *ngIf="profileImage1Preview" [src]="profileImage1Preview" alt="Preview" />
            </div>
          </label>
          <button *ngIf="profileImage1" class="btn-remove-image" (click)="removeImage(1)" type="button">
            ✕ Eliminar
          </button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div class="loader-overlay" *ngIf="loading">
      <div class="spinner"></div>
      <p>Registrando usuario...</p>
    </div>

    <!-- Captcha -->
    <app-captcha (onValidated)="onCaptchaValidated($event)"></app-captcha>

    <button (click)="register()" class="btn-register" [disabled]="loading || !isFormValid()">Registrarse</button>

    <div class="login-link">
      <p>¿Ya tenés cuenta?</p>
      <button class="btn-link-login" (click)="goToLogin()">Iniciá sesión aquí</button>
    </div>
  </div>
</div>

<app-confirmation-modal
  [isVisible]="showBackConfirmation"
  [title]="'¿Volver atrás?'"
  [message]="'¿Estás seguro que deseas volver? Los datos del formulario se perderán.'"
  [confirmText]="'Sí, volver'"
  [cancelText]="'Cancelar'"
  (onConfirm)="confirmGoBack()"
  (onCancel)="cancelGoBack()">
</app-confirmation-modal>
