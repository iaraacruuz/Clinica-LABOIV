<div class="mis-turnos-container">
  <h1 class="page-title">Mis Turnos - Especialista</h1>

  <!-- Filtro Global -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="searchText">üîç Buscar en turnos e historias cl√≠nicas:</label>
      <input
        type="text"
        id="searchText"
        [(ngModel)]="searchText"
        (input)="onSearchChange()"
        placeholder="Buscar por paciente, especialidad, fecha, diagn√≥stico, presi√≥n, etc..."
        class="filter-input search-input"
      />
      <small class="filter-hint">
        Pod√©s buscar por cualquier campo: paciente, especialidad, estado, diagn√≥stico, altura, peso, temperatura, presi√≥n, o campos personalizados de la historia cl√≠nica.
      </small>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando turnos...</p>
  </div>

  <!-- Lista de turnos -->
  <div *ngIf="!loading && filteredAppointments.length === 0" class="no-appointments">
    <p>No tienes turnos asignados</p>
  </div>

  <div *ngIf="!loading && filteredAppointments.length > 0" class="appointments-grid">
    <div *ngFor="let appointment of filteredAppointments" class="appointment-card">
      <!-- Header con estado -->
      <div class="card-header">
        <span class="status-badge" [ngClass]="getStatusClass(appointment.status_id)">
          {{ getStatusText(appointment.status_id) }}
        </span>
        <span class="specialty-badge">{{ appointment.specialty_name }}</span>
      </div>

      <!-- Informaci√≥n del turno -->
      <div class="card-body">
        <div class="info-row">
          <strong>Paciente:</strong>
          <span>{{ appointment.patient_name }} {{ appointment.patient_last_name }}</span>
        </div>

        <div class="info-row">
          <strong>Fecha y hora:</strong>
          <span>{{ formatDate(appointment.appointment_date, appointment.appointment_time) }}</span>
        </div>

        <div class="info-row">
          <strong>Duraci√≥n:</strong>
          <span>{{ appointment.duration_minutes }} minutos</span>
        </div>

        <!-- Motivo de cancelaci√≥n si existe -->
        <div *ngIf="appointment.cancellation_reason" class="info-row reason-row">
          <strong>Motivo de cancelaci√≥n:</strong>
          <p>{{ appointment.cancellation_reason }}</p>
        </div>

        <!-- Motivo de rechazo si existe -->
        <div *ngIf="appointment.rejection_reason" class="info-row reason-row">
          <strong>Motivo de rechazo:</strong>
          <p>{{ appointment.rejection_reason }}</p>
        </div>
      </div>

      <!-- Acciones -->
      <div class="card-actions">
        <button
          *ngIf="canAccept(appointment)"
          (click)="openAcceptModal(appointment)"
          class="btn btn-accept"
        >
          ‚úì Aceptar Turno
        </button>

        <button
          *ngIf="canReject(appointment)"
          (click)="openRejectModal(appointment)"
          class="btn btn-reject"
        >
          ‚úó Rechazar Turno
        </button>

        <button
          *ngIf="canCancel(appointment)"
          (click)="openCancelModal(appointment)"
          class="btn btn-cancel"
        >
          üö´ Cancelar Turno
        </button>

        <button
          *ngIf="canComplete(appointment)"
          (click)="openCompleteModal(appointment)"
          class="btn btn-complete"
        >
          ‚úîÔ∏è Finalizar Turno
        </button>

        <button
          *ngIf="canViewReview(appointment)"
          (click)="openReviewModal(appointment)"
          class="btn btn-review"
        >
          üìã Ver Rese√±a
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Aceptar Turno -->
  <div *ngIf="showAcceptModal" class="modal-overlay" (click)="closeAcceptModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Aceptar Turno</h2>
      <p>¬øEst√°s seguro que quer√©s aceptar este turno?</p>
      
      <div class="appointment-summary" *ngIf="selectedAppointment">
        <p><strong>Paciente:</strong> {{ selectedAppointment.patient_name }} {{ selectedAppointment.patient_last_name }}</p>
        <p><strong>Fecha:</strong> {{ formatDate(selectedAppointment.appointment_date, selectedAppointment.appointment_time) }}</p>
        <p><strong>Especialidad:</strong> {{ selectedAppointment.specialty_name }}</p>
      </div>

      <div class="modal-actions">
        <button (click)="confirmAccept()" class="btn btn-primary">S√≠, Aceptar</button>
        <button (click)="closeAcceptModal()" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Rechazar Turno -->
  <div *ngIf="showRejectModal" class="modal-overlay" (click)="closeRejectModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Rechazar Turno</h2>
      <p>Por favor, indic√° el motivo del rechazo:</p>

      <div class="form-group">
        <label for="rejectionReason">Motivo del rechazo *</label>
        <textarea
          id="rejectionReason"
          [(ngModel)]="rejectionReason"
          rows="4"
          placeholder="Ej: No tengo disponibilidad en ese horario..."
          required
        ></textarea>
      </div>

      <div class="modal-actions">
        <button 
          (click)="confirmReject()" 
          class="btn btn-primary"
          [disabled]="!rejectionReason.trim()"
        >
          Confirmar Rechazo
        </button>
        <button (click)="closeRejectModal()" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Cancelar Turno -->
  <div *ngIf="showCancelModal" class="modal-overlay" (click)="closeCancelModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Cancelar Turno</h2>
      <p>Por favor, indic√° el motivo de la cancelaci√≥n:</p>

      <div class="form-group">
        <label for="cancellationReason">Motivo de la cancelaci√≥n *</label>
        <textarea
          id="cancellationReason"
          [(ngModel)]="cancellationReason"
          rows="4"
          placeholder="Ej: Emergencia personal..."
          required
        ></textarea>
      </div>

      <div class="modal-actions">
        <button 
          (click)="confirmCancel()" 
          class="btn btn-primary"
          [disabled]="!cancellationReason.trim()"
        >
          Confirmar Cancelaci√≥n
        </button>
        <button (click)="closeCancelModal()" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Finalizar Turno con Historia Cl√≠nica -->
  <div *ngIf="showMedicalHistoryModal" class="modal-overlay" (click)="closeCompleteModal()">
    <div class="modal-content medical-history-modal" (click)="$event.stopPropagation()">
      <h2>üìã Completar Historia Cl√≠nica</h2>
      <p class="modal-subtitle">Paciente: <strong>{{ selectedAppointment?.patient_name }} {{ selectedAppointment?.patient_last_name }}</strong></p>

      <div class="medical-form">
        <!-- Datos b√°sicos -->
        <div class="form-section">
          <h3>Datos F√≠sicos</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="height">Altura (cm)</label>
              <input
                type="number"
                id="height"
                [(ngModel)]="medicalHistory.height"
                placeholder="Ej: 170"
                min="0"
                step="0.1"
              />
            </div>

            <div class="form-group">
              <label for="weight">Peso (kg)</label>
              <input
                type="number"
                id="weight"
                [(ngModel)]="medicalHistory.weight"
                placeholder="Ej: 70"
                min="0"
                step="0.1"
              />
            </div>

            <div class="form-group">
              <label for="temperature">Temperatura (¬∞C)</label>
              <input
                type="number"
                id="temperature"
                [(ngModel)]="medicalHistory.temperature"
                placeholder="Ej: 36.5"
                min="35"
                max="42"
                step="0.1"
              />
            </div>

            <div class="form-group">
              <label for="pressure">Presi√≥n Arterial</label>
              <input
                type="text"
                id="pressure"
                [(ngModel)]="medicalHistory.pressure"
                placeholder="Ej: 120/80"
              />
            </div>
          </div>
        </div>

        <!-- Diagn√≥stico y observaciones -->
        <div class="form-section">
          <h3>Diagn√≥stico *</h3>
          <div class="form-group">
            <textarea
              id="diagnosis"
              [(ngModel)]="medicalHistory.diagnosis"
              rows="4"
              placeholder="Diagn√≥stico m√©dico..."
              required
            ></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3>Observaciones</h3>
          <div class="form-group">
            <textarea
              id="observations"
              [(ngModel)]="medicalHistory.observations"
              rows="3"
              placeholder="Observaciones adicionales, tratamiento sugerido, etc..."
            ></textarea>
          </div>
        </div>

        <!-- Campos adicionales din√°micos -->
        <div class="form-section">
          <h3>Datos Cl√≠nicos Adicionales</h3>
          
          <!-- Sprint 5: Campos Din√°micos Espec√≠ficos -->
          <div class="dynamic-controls-section">
            <h4>Evaluaci√≥n del Paciente (Sprint 5)</h4>
            
            <div class="form-row">
              <!-- Control de Rango 0-100 -->
              <div class="form-group range-control">
                <label for="rangeField">
                  Nivel de Dolor: <strong>{{ medicalHistory.rangeField }}</strong>/100
                </label>
                <input
                  type="range"
                  id="rangeField"
                  min="0"
                  max="100"
                  step="1"
                  [(ngModel)]="medicalHistory.rangeField"
                  class="range-slider"
                />
                <div class="range-labels">
                  <span>0 (Sin dolor)</span>
                  <span>50 (Moderado)</span>
                  <span>100 (Severo)</span>
                </div>
              </div>
            </div>

            <div class="form-row">
              <!-- Campo Num√©rico -->
              <div class="form-group">
                <label for="numericField">D√≠as con S√≠ntomas</label>
                <input
                  type="number"
                  id="numericField"
                  [(ngModel)]="medicalHistory.numericField"
                  placeholder="¬øCu√°ntos d√≠as tiene los s√≠ntomas?"
                  min="0"
                />
              </div>

              <!-- Switch Si/No -->
              <div class="form-group switch-control">
                <label for="switchField">¬øRequiere Seguimiento?</label>
                <div class="switch-container">
                  <label class="switch">
                    <input
                      type="checkbox"
                      id="switchField"
                      [(ngModel)]="medicalHistory.switchField"
                    />
                    <span class="slider round"></span>
                  </label>
                  <span class="switch-label">
                    {{ medicalHistory.switchField ? 'S√≠' : 'No' }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Campos fijos predefinidos -->
          <div class="fixed-fields-section">
            <h4>Campos Obligatorios</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="fixedField1">S√≠ntoma Principal</label>
                <input
                  type="text"
                  id="fixedField1"
                  [(ngModel)]="medicalHistory.fixedField1Value"
                  placeholder="Ej: Dolor de cabeza, fiebre, tos..."
                />
              </div>
              <div class="form-group">
                <label for="fixedField2">√Årea Afectada</label>
                <input
                  type="text"
                  id="fixedField2"
                  [(ngModel)]="medicalHistory.fixedField2Value"
                  placeholder="Ej: Pierna, brazo, abdomen..."
                />
              </div>
            </div>
          </div>

          <!-- Campos adicionales opcionales -->
          <div class="dynamic-fields-section">
            <h4>Campos Adicionales (Opcional)</h4>
            <small>Agreg√° hasta 3 campos personalizados si es necesario</small>

            <div *ngFor="let field of dynamicFields; let i = index" class="form-row additional-field">
              <div class="form-group">
                <input
                  type="text"
                  [(ngModel)]="field.key"
                  placeholder="Nombre del campo (Ej: Alergias)"
                />
              </div>
              <div class="form-group">
                <input
                  type="text"
                  [(ngModel)]="field.value"
                  placeholder="Valor"
                />
              </div>
              <button 
                type="button" 
                class="btn-remove-field" 
                (click)="removeDynamicField(i)"
                title="Eliminar campo"
              >
                ‚úï
              </button>
            </div>

            <button 
              *ngIf="dynamicFields.length < 3" 
              type="button" 
              class="btn-add-field" 
              (click)="addDynamicField()"
            >
              + Agregar campo adicional
            </button>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button 
          (click)="confirmComplete()" 
          class="btn btn-primary"
          [disabled]="!medicalHistory.diagnosis.trim() || loading"
        >
          {{ loading ? 'Guardando...' : 'Finalizar y Guardar' }}
        </button>
        <button (click)="closeCompleteModal()" class="btn btn-secondary" [disabled]="loading">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Ver Rese√±a -->
  <div *ngIf="showReviewModal" class="modal-overlay" (click)="closeReviewModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Rese√±a de la Consulta</h2>
      
      <div class="review-content" *ngIf="selectedAppointment">
        <p><strong>Paciente:</strong> {{ selectedAppointment.patient_name }} {{ selectedAppointment.patient_last_name }}</p>
        <p><strong>Fecha:</strong> {{ formatDate(selectedAppointment.appointment_date, selectedAppointment.appointment_time) }}</p>
        
        <div class="review-text">
          <h3>Diagn√≥stico y observaciones:</h3>
          <p>{{ selectedAppointment.specialist_review }}</p>
        </div>

        <div *ngIf="selectedAppointment.patient_feedback" class="patient-feedback">
          <h3>Comentario del paciente:</h3>
          <p>{{ selectedAppointment.patient_feedback }}</p>
          <div *ngIf="selectedAppointment.patient_rating" class="rating-display">
            <span class="stars">
              <span *ngFor="let star of [1,2,3,4,5]" 
                    [class.filled]="star <= (selectedAppointment.patient_rating || 0)">
                ‚òÖ
              </span>
            </span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="closeReviewModal()" class="btn btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>
</div>
