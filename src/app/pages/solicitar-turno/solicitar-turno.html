<div class="solicitar-turno-container">
  <h1 class="page-title">Solicitar Turno</h1>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- Formulario principal -->
  <div *ngIf="!loading" class="appointment-form">
    
    <!-- Paso 1: Seleccionar Especialidad -->
    <div class="form-step">
      <h2>1. Seleccionar Especialidad</h2>
      <div class="specialty-grid">
        <button 
          *ngFor="let specialty of specialties"
          class="specialty-btn"
          [class.selected]="selectedSpecialtyId === specialty.id"
          (click)="selectedSpecialtyId = specialty.id; onSpecialtyChange()"
        >
          <div class="specialty-icon">
            <img *ngIf="specialty.image_url" [src]="specialty.image_url" [alt]="specialty.name" />
            <img *ngIf="!specialty.image_url" src="clinic-icon.svg" [alt]="specialty.name" class="default-icon" />
          </div>
          <span class="specialty-name">{{ specialty.name }}</span>
        </button>
      </div>
    </div>

    <!-- Paso 2: Seleccionar Especialista -->
    <div *ngIf="selectedSpecialtyId" class="form-step">
      <h2>2. Seleccionar Especialista</h2>
      
      <div *ngIf="specialists.length === 0 && !loadingSlots" class="no-specialists">
        <p>No hay especialistas disponibles para esta especialidad</p>
      </div>
      
      <div *ngIf="loadingSlots" class="loading-specialists">
        <div class="spinner-small"></div>
        <span>Cargando especialistas...</span>
      </div>
      
      <div class="specialist-grid">
        <button 
          *ngFor="let specialist of specialists"
          class="specialist-btn"
          [class.selected]="selectedSpecialistId === specialist.id"
          (click)="selectedSpecialistId = specialist.id; onSpecialistChange()"
        >
          <h3 class="specialist-name">{{ specialist.name }} {{ specialist.last_name }}</h3>
          <div class="specialist-photo">
            <img *ngIf="specialist.profile_image_url" [src]="specialist.profile_image_url" [alt]="specialist.name" />
            <div *ngIf="!specialist.profile_image_url" class="specialist-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
          </div>
          <p class="specialist-specialty">{{ getSpecialtyName(selectedSpecialtyId) }}</p>
        </button>
      </div>
    </div>

    <!-- Paso 3: Seleccionar Paciente (solo admin) -->
    <div *ngIf="isAdmin && selectedSpecialistId" class="form-step">
      <h2>3. Seleccionar Paciente</h2>
      <div class="form-group">
        <select 
          [(ngModel)]="selectedPatientId" 
          class="patient-select"
          required
        >
          <option value="">Seleccionar paciente...</option>
          <option *ngFor="let patient of patients" [value]="patient.id">
            {{ patient.name }} {{ patient.last_name }} - DNI: {{ patient.dni }}
          </option>
        </select>
      </div>
    </div>

    <!-- Paso 4: Seleccionar Horario -->
    <div *ngIf="selectedSpecialistId && (!isAdmin || selectedPatientId)" class="form-step">
      <h2>{{ isAdmin ? '4' : '3' }}. Seleccionar Horario</h2>
      
      <div *ngIf="loadingSlots" class="loading-slots">
        <div class="spinner-small"></div>
        <span>Cargando horarios disponibles...</span>
      </div>
      
      <div *ngIf="!loadingSlots && availableSlots.length === 0" class="no-slots">
        <p>No hay horarios disponibles para este especialista en los pr칩ximos {{ DAYS_AHEAD }} d칤as</p>
        <p class="clinic-hours-info">
          <strong>Horarios de la cl칤nica:</strong><br>
          Lunes a Viernes: 8:00 - 19:00<br>
          S치bados: 8:00 - 14:00<br>
          Domingos: Cerrado
        </p>
      </div>
      
      <div *ngIf="!loadingSlots && availableSlots.length > 0" class="time-slots">
        <div *ngFor="let dateGroup of getGroupedSlots() | keyvalue" class="date-group">
          <button 
            class="date-btn"
            [class.has-selected-time]="hasSelectedTimeInDate(dateGroup.key)"
            (click)="toggleDateExpansion(dateGroup.key)"
          >
            <div class="date-content">
              <span class="day-name">{{ dateGroup.value[0].dayName | titlecase }}</span>
              <span class="date-number">{{ dateGroup.key }}</span>
            </div>
            <svg class="expand-icon" [class.expanded]="isDateExpanded(dateGroup.key)" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          
          <div class="slots-grid" *ngIf="isDateExpanded(dateGroup.key)">
            <button 
              *ngFor="let slot of dateGroup.value"
              class="time-slot-btn"
              [class.selected]="selectedTimeSlot === slot"
              [disabled]="!slot.available"
              (click)="selectTimeSlot(slot)"
            >
              {{ slot.time }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen y confirmaci칩n -->
    <div *ngIf="selectedTimeSlot" class="confirmation-step">
      <h2>Confirmar Turno</h2>
      
      <div class="appointment-summary">
        <h3>Resumen del turno:</h3>
        
        <div class="summary-item">
          <strong>Especialidad:</strong>
          <span>{{ getSpecialtyName(selectedSpecialtyId!) }}</span>
        </div>
        
        <div class="summary-item">
          <strong>Especialista:</strong>
          <span>{{ getSpecialistName(selectedSpecialistId) }}</span>
        </div>
        
        <div class="summary-item" *ngIf="isAdmin">
          <strong>Paciente:</strong>
          <span>{{ getPatientName(selectedPatientId) }}</span>
        </div>
        
        <div class="summary-item">
          <strong>Fecha:</strong>
          <span>{{ selectedTimeSlot.dayName | titlecase }}, {{ selectedTimeSlot.formattedDate }}</span>
        </div>
        
        <div class="summary-item">
          <strong>Horario:</strong>
          <span>{{ selectedTimeSlot.time }} ({{ SLOT_DURATION }} minutos)</span>
        </div>
      </div>
      
      <div class="form-actions">
        <button 
          (click)="confirmAppointment()" 
          class="btn btn-primary"
          [disabled]="loading"
        >
          <span *ngIf="loading">Solicitando...</span>
          <span *ngIf="!loading">Confirmar Turno</span>
        </button>
        
        <button 
          (click)="resetForm()" 
          class="btn btn-secondary"
          [disabled]="loading"
        >
          Cancelar
        </button>
      </div>
      
      <div class="appointment-note">
        <p>
          游늶 <strong>Nota:</strong> Una vez solicitado, el turno quedar치 en estado "Pendiente" 
          hasta que el especialista lo acepte. Recibir치s una confirmaci칩n cuando esto ocurra.
        </p>
      </div>
    </div>
  </div>
</div>